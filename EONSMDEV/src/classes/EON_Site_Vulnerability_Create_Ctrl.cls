/**
    Description : This class is used for the extension controller for the page : EON_Site_Vulnerability_Create
    Test Class : EON_Site_Vulnerability_Create_Ctrl_Test
**/
/*
    Created By : Praveen G
    Created Date : 10/03/2017
    Service Request : SR_EON_PC_105
*/

public class EON_Site_Vulnerability_Create_Ctrl{

    //Instance Variables
    public String siteName{get;set;}
    public String customerName{get;set;}
    public String vulDate{get;set;}
    public String selectedVCode{get;set;}
    public EON_Site_Vulnerability__c record {get;set;}
    public String siteID{get;set;}
    public String selectedVType{get;set;}
    
    /**
        EON_Site_Vulnerability_Create_Ctrl(ApexPages.StandardController stdController) - 
            Standard controller constructor.
    **/
    public EON_Site_Vulnerability_Create_Ctrl(ApexPages.StandardController stdController) {
        record = (EON_Site_Vulnerability__c)stdController.getRecord();
        siteID = ApexPages.currentPage().getParameters().get('siteID');
        Eon_Site__C siteRec = [select id, Name, Customer__r.Name from Eon_Site__c where id =:siteID];
        siteName = siteRec.Name;
        customerName = siteRec.Customer__r.Name;
        vulDate = System.today().format();
    }
    
    /**
        getVulnerabilitycodes() - This method returns the Vulnerabilitycodes. This list will be displayed in the pick list.
    **/    
    public List<SelectOption> getVulnerabilitycodes(){
        Set<String> controlSet = new Set<String>(); // this is to avoid duplicate contracts in the options
        List<SelectOption> lstCodeOption = new List<SelectOption>(); 
        lstCodeOption.add(new SelectOption('', 'None'));
        List<EON_Vulnerability_Code__c> lstVulcode = [select id, Name from EON_Vulnerability_Code__c where isDeleted = false];
        
        for(EON_Vulnerability_Code__c code : lstVulcode){
            if(!controlSet.contains(code.Name)){
                controlSet.add(code.Name);
                lstCodeOption.add(new SelectOption(code.ID, code.Name)); 
            }
        }
        
        return lstCodeOption;
    }    
    
    /**
        saveRec() - This method is used to override the standard save and saves the record.
    **/
    public pageReference saveRec(){
        try{
            //validate
            if(selectedVCode == null || selectedVCode ==''){
                Apexpages.addMessage(new ApexPages.Message(ApexPages.Severity.ERROR,'Error : Please select Vulnerability code' ));
                return null;
            }else{
                EON_Site_Vulnerability__c[] records = [select id from EON_Site_Vulnerability__c where
                                                        Premise__c =: siteID and 
                                                        Vulnerability_Type__c =: selectedVType and
                                                        Vulnerability_code__c =: selectedVCode];
                if(!records.isEmpty()){
                    Apexpages.addMessage(new ApexPages.Message
                                            (ApexPages.Severity.ERROR,'Error : Vulnerability cannot be inserted as already exists'));
                    return null;
                }                                                        
            }    
            
            EON_Site__c site = [select Customer__c from EON_Site__c where id=:siteID];
            
            record.Premise__c = siteID;
            record.Customer__c = site.Customer__c;
            record.Vulnerability_code__c = selectedVCode;
            record.EON_Site_Vulnerability_Change_Type__c = 'I';
            record.Vulnerability_Type__c = selectedVType;
            upsert record;
            
            return (new PageReference('/'+siteID));
        }catch(Exception e){
            System.debug('Exception occured ' + e.getStackTraceString());
                Apexpages.addMessage(new ApexPages.Message(ApexPages.Severity.ERROR,'Error :' + e.getStackTraceString()));            
        }
        
        return null;
    }
    
    /**
        gotoSite()- this method is used to redirect to site reocrd.
    **/
    public PageReference gotoSite(){
        return (new PageReference('/'+siteID));
    }
    
    /**
        getVCodes() - this method is used to display the v codes.
    **/
    public List<SelectOption> getVCodes() {
        List<SelectOption> options = new List<SelectOption>();
        options.add(new SelectOption('C','C'));
        options.add(new SelectOption('H','H'));
        return options;
    }    
}